name: ci
on:
  push:
    branches-ignore:
      - 'translations**'
  pull_request:
    branches-ignore:
      - 'translations**'
env:
  DEFAULT_PYTHON_VERSION: "3.11"

jobs:
  detect-duplicate:
    name: Detect Duplicate Run
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if workflow should run
        id: check
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if (context.eventName !== 'push') {
              core.info('Not a push event; running workflow.');
              core.setOutput('should_run', 'true');
              return;
            }

            const ref = context.ref || '';
            if (!ref.startsWith('refs/heads/')) {
              core.info('Push is not to a branch; running workflow.');
              core.setOutput('should_run', 'true');
              return;
            }

            const branch = ref.substring('refs/heads/'.length);
            const { owner, repo } = context.repo;
            const prs = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: 'open',
              head: `${owner}:${branch}`,
              per_page: 100,
            });

            if (prs.length === 0) {
              core.info(`No open PR found for ${branch}; running workflow.`);
              core.setOutput('should_run', 'true');
            } else {
              core.info(`Found ${prs.length} open PR(s) for ${branch}; skipping duplicate push run.`);
              core.setOutput('should_run', 'false');
            }

  # ============================================================================
  # LINTING: Validación de código (formato, sintaxis, style)
  # ============================================================================
  pre-commit:
    needs:
      - detect-duplicate
    if: needs.detect-duplicate.outputs.should_run == 'true'
    name: Linting Checks
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}

      - name: Check files
        uses: pre-commit/action@v3.0.1
